<!--
    @license
    This file is part of POLYWC library.

    POLYWC is free software: you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    JSDataChecker is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Lesser General Public License for more details.

    Copyright (C) 2016 POLYWC - Donato Pirozzi (donatopirozzi[at]gmail[dot]com)
    Distributed under the GNU LGPL v3. For full terms see the file LICENSE.
    License: http://www.gnu.org/licenses/lgpl.html LGPL version 3 or higher
-->

<!--
*    Contributors: Donato Pirozzi (donatopirozzi[at]gmail[dot]com)
*    Last change: 2016-04-04
*    Single file version: v0.3.1
-->

<!-- Polymer libraries -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<!-- JQuery -->
<!--<script src="../../bower_components/jquery/dist/jquery.min.js"></script>
<script src="utils.js"></script>-->

<!-- Semantic UI -->
<!--<link rel="stylesheet" type="text/css" href="../../bower_components/semantic/dist/semantic.css">
<script src="../../bower_components/semantic/dist/semantic.min.js"></script>
-->

<!-- Include CUSTOM Web Components -->
<link rel="import" href="../data-table-pager/data-table-pager.html">

<!-- Import behaviours -->
<link rel="import" href="../data-table-pager/pager-array-behaviour.html">

<!--

`polywc-data-table` is a simple web-component table, showing headers and data as well as controls.

The web-component can be used in two ways: statically or dynamically.

The simplest way to use it is the following, which shows a table with three columns:

     <data-table headers='["id", "Author", "Title", "Year"]'
                field-id="id" fields='["id", "author", "title", "year"]'
                fields-data='[ {"id":"1", "author":"Dan Brown", "title":"The Da Vinci Code", "year": 2003},
                               {"id":"1", "author":"Dan Brown", "title":"Deception point", "year": 2001} ]'>
     </data-table>

-->
<dom-module is="data-table">
    <template>

        <table class="ui compact celled striped table">
            <thead id="tblheader">
                <tr>
                	<template is="dom-if" if="{{showControls}}">
                    	<th id="tblheadercheckboxes"></th>
                    </template>
                    <template is="dom-repeat" items="{{headers}}">
                        <th>{{item}}</th>
                    </template>
                    <th id="tblheaderoptions">
                    	<!--<template is="dom-if" if="{{showPager}}">
                        <data-table-pager id="topPager" tot-items="7"></data-table-pager>
                        </template>-->
                    </th>
                </tr>
            </thead>
            <tbody id="tblbody">
                <template is="dom-repeat" items="{{fieldsData}}" as="dataRow">
                <tr id="{{dataRow.id}}">
                	<template is="dom-if" if="{{showControls}}">
                    <td><paper-checkbox id="{{dataRow.id}}" on-change="handleCheck"></paper-checkbox></td>
                    </template>
                    <template is="dom-repeat" items="{{fields}}" as="fieldKey">
                    <td>{{computeFieldValue(dataRow, fieldKey)}}</td>
                    </template>
                    
                    <td class="colCenter">
                    	<template is="dom-if" if="{{showControls}}">
                        <a href="{{ computeComposeUrl(serviceEditUrl, 'id', dataRow.id) }}">Edit</a>
                        <paper-icon-button id="edit_{{dataRow.id}}" icon="editor:mode-edit" on-click="handleEdit"></paper-icon-button>
                        <paper-icon-button id="delete_{{dataRow.id}}" icon="icons:delete" on-click="handleDelete"></paper-icon-button>
                        </template>
                        
                        <template is="dom-if" if="showCtrlView">
                        <paper-icon-button id="details_{{computeFieldValue(dataRow, fieldId)}}" icon="icons:visibility" on-click="handleViewDetails"></paper-icon-button>
                        </template>
                    </td>
                    
                </tr>
                </template>
            </tbody>
            <template is="dom-if" if="{{showPager}}">
            <tfoot id="tblfoot">
            <tr>
                <th colspan="100%">
                    <div id="tblfooter">
                        <div id="tblfootercaption"></div>
                        <div class="flexchild right">
                            <paper-fab mini icon="icons:delete" on-click="handleDeleteClick" style="display: none;"></paper-fab>
                            <data-table-pager id="bottomPager" show-page-label tot-items="7"></data-table-pager>
                        </div>
                    </div>
                </th>
            </tr>
            </tfoot>
            </template>
        </table>

    </template>
    <style>

        table, td {
            border: 1px solid;
        }

        #tblheadercheckboxes { width: 8px; }
        #tblheaderoptions { width: 16px; }

        paper-icon-button {
            height: 24px;
            width: 24px;
            padding: 2px 2px 2px 2px;
            margin: 0px 0px 0px 0px;
        }

        #tblfootercontrols {
            text-align: right;
        }

        paper-fab {
            display: inline-flex;
        }

        .colCenter { text-align: center; }
        .right { text-align: right; }

        .tblrowselected { background-color: lightyellow; }

        #tblfooter {
            @apply(--layout-horizontal);
        }
        .flexchild {
            @apply(--layout-flex);
        }

    </style>
    <script>
        Polymer({
            is: "data-table",
            properties: {
                headers:            { type: Array, value: undefined },
                fieldId:            { type: String },
                fields:             { type: Array, value: undefined },
                fieldsData:         { type: Object, value: undefined, notify: true, observer: 'handleResponseChange' },

                //Rendering options.
                showPager: 			{ type: Boolean, value: false },
                itemsPerPage:       { type: Number, value: 5 },

                //TODO: check if they need to be removed.
                dataUrl:            { type: String, value: undefined },
                serviceEditUrl:     { type: String, value: undefined },
                _numSelectedItems:  { type: Number, value: 0 },
                
                //response: 			{ type: Object, value: undefined, notify: true, observer: 'handleResponseChange' },


                showControls: 		{ type: Boolean, value: false },
                showCtrlView:		{ type: Boolean, value: false }
            },

            behaviors: [PagerArrayBehaviour],

            computeFieldValue: function(dataRow, fieldKey) {
            	var value = dataRow[fieldKey];
                return value;
            },

            computeComposeUrl: function(baseUrl, paramName, paramValue) {
                return replaceUrlParam(baseUrl, paramName, paramValue);
            },

            listeners: {
                'data-table-pager-go-to-event': 'goToPage'
            },

            handleResponseChange: function() {
            	console.log("ciao");	
            },
            
            handleCheck: function(evt) {
                var _id = evt.target.id;
                var _checked = evt.target.checked;

                this._numSelectedItems += _checked ? 1 : -1 ;
                Polymer.dom(this.$.tblfootercaption).innerHTML = this._numSelectedItems > 0 ? this._numSelectedItems + " selezionati." : "";

                var _selectedRow = Polymer.dom(this.$.tblbody).querySelector("tr[id='" + _id + "']");
                _checked ?  _selectedRow.classList.add('tblrowselected') : _selectedRow.classList.remove('tblrowselected');
            },

            refresh: function() {
                var $bottomPager = this.$$('#bottomPager');
                var curPage = $bottomPager.curPage;
                var itemsPerPage = $bottomPager.itemsPerPage;
                this._loadPage(curPage, itemsPerPage);
            },

            goToPage: function(evt, details) {
                this._loadPage(details.targetPage, details.itemsPerPage);
            },

            _loadPage: function(targetPage, itemsPerPage) {
                var arrData = this.load(targetPage, itemsPerPage);
                this.fieldsData = arrData;
                this.$$('#bottomPager').curPage = targetPage;
                this.$._numSelectedItems = 0;
            },

            handleEdit: function(evt) {
                var _id = evt.currentTarget.id;
                this.fire('data-table-edit-item', _id );
            },

            handleDelete: function(evt) {
                var _id = evt.currentTarget.id;
                this.fire('data-table-delete-item', _id );
            },
            
            handleViewDetails: function(evt) {
            	var _id = evt.currentTarget.id;
            	this.fire('data-table-view-item-details', _id );
            }

        });//#POLYMER.
    </script>
</dom-module>
